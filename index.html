<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sala - FORTUNY</title>

  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />

  <style>
    :root{
      /* paleta oto√±al */
      --bg:#f3efe7;
      --panel:#fff8f3;
      --accent:#a86f3f;
      --accent-dark:#7e4e2d;
      --muted:#d6b89a;
      --text:#362b24;
      --white:#ffffff;

      /* tipos */
      --vacaciones-dark: #a15a36; /* oscuro rojizo */
      --libre-light: #f6dcc4; /* claro crema */
      --asuntos-mid: #d7a67f; /* medio */

      /* status */
      --status-approved: #7fb26f;
      --status-rejected: #c86b6b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }
    header{
      background:linear-gradient(90deg,var(--accent) 0%, #b8926f 100%);
      color:var(--white);
      padding:18px 12px;
      text-align:center;
      box-shadow:0 4px 12px rgba(0,0,0,0.06);
    }
    header h1{ margin:0; font-size:1.25rem; letter-spacing:0.4px; font-weight:700;}
    .wrap{
      max-width:1100px;
      margin:26px auto;
      padding:0 16px 60px;
    }
    .top-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:14px;
    }
    #infoEmpleado{
      background:var(--panel);
      padding:10px 12px;
      border-radius:10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.04);
      display:flex;
      gap:12px;
      align-items:center;
    }
    #infoEmpleado select{
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #e6d9c8;
      background: var(--white);
      color:var(--text);
      font-weight:600;
    }
    #contador{
      font-size:0.95rem;
      color:var(--accent-dark);
      font-weight:700;
      display:flex;
      align-items:center;
      gap:10px;
    }
    #adminBtn{
      background:transparent;
      border:1px dashed rgba(61,47,42,0.12);
      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
      color:var(--accent-dark);
      font-weight:600;
    }
    #calendar{
      background:var(--panel);
      border-radius:12px;
      padding:18px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }

    /* modal */
    .modal {
      display:none;
      position:fixed;
      z-index:60;
      left:0; top:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.35);
      justify-content:center;
      align-items:center;
    }
    .modal-content{
      background:var(--white);
      width:92%;
      max-width:640px;
      border-radius:12px;
      padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,0.18);
    }
    .modal-content h2{ margin:0 0 8px 0; color:var(--accent-dark); }
    label{ display:block; margin-top:10px; font-weight:600; color:var(--accent-dark); font-size:0.95rem;}
    input[type="datetime-local"], input[type="email"], select, textarea {
      width:100%;
      padding:9px 10px;
      border-radius:8px;
      border:1px solid #e6d9c8;
      margin-top:6px;
      font-size:0.95rem;
      background: #fff;
    }
    textarea{ resize:vertical; min-height:80px; }
    .row{
      display:flex; gap:8px; align-items:center; margin-top:6px;
    }
    .btn {
      background:var(--accent);
      color:var(--white);
      border:none;
      padding:10px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
      margin-top:14px;
    }
    .btn.secondary{
      background:var(--muted);
      color:var(--accent-dark);
      margin-left:8px;
    }
    .close{
      float:right; font-size:20px; cursor:pointer; color:#9c7f67;
    }
    .small-muted{font-size:0.9rem;color:#7a6a5d}
    /* events */
    .fc-event {
      border: none;
      padding:3px 6px;
      border-radius:6px;
      font-weight:700;
      font-size:0.8rem;
    }
    .fc .fc-daygrid-event .fc-event-title { color:var(--accent-dark) }
    @media (max-width:700px){
      .top-row{flex-direction:column;align-items:stretch;}
    }

    /* admin table styling */
    table.admin-table { width:100%; border-collapse:collapse; margin-top:8px; }
    table.admin-table th, table.admin-table td { padding:6px 8px; text-align:left; border-bottom:1px solid #f0e7de; font-size:0.9rem; }

  </style>
</head>
<body>
  <header>
    <h1>Sala - FORTUNY</h1>
  </header>

  <div class="wrap">
    <div class="top-row">
      <div id="infoEmpleado" aria-hidden="false">
        <div style="margin-right:8px;font-size:0.95rem;color:var(--accent-dark);font-weight:700">Empleado:</div>
        <select id="empleadoSelect" aria-label="Selecciona empleado">
          <option value="">Selecciona tu nombre</option>
          <option>Justo Gomez</option>
          <option>Yustin Zambrano</option>
          <option>Julio Arias</option>
          <option>Francisco Soriano</option>
          <option>Valentin Naranjo</option>
          <option>Michelle Autelitano</option>
          <option>Santiago Germain</option>
          <option>Sanguita Karki</option>
          <option>Marianita Kurys</option>
          <option>Camila Calzadilla</option>
          <option>Gimena Vicente</option>
          <option>Radhika Barea</option>
          <option>Andrei Belei</option>
          <option>Marcos Fernandez</option>
          <option>Laura Delgado</option>
          <option>Enric Conill</option>
          <option>Gabriel Flores</option>
          <option>Alejandro Re√±e</option>
          <option>Juliette Christiane</option>
          <option>Kiara Soledad</option>
          <option>Juana Ambrosoni</option>
          <option>Armin Rajabicheraghabadi</option>
          <option>Diego Lopez</option>
          <option>Julieta Salomone</option>
        </select>
      </div>

      <div style="display:flex;gap:12px;align-items:center">
        <div id="contador">D√≠as disponibles: <span id="diasRestantes">30</span></div>
        <button id="adminBtn" title="Entrar como administrador">Entrar administrador</button>
      </div>
    </div>

    <div id="calendar"></div>
  </div>

  <!-- Modal (formulario) -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content" role="document">
      <span class="close" id="closeModal">&times;</span>
      <h2 id="modalTitle">Solicitud de tiempo</h2>

      <form id="solicitudForm" aria-label="Formulario de solicitud">
        <label for="tipo">Tipo de solicitud</label>
        <select id="tipo" required>
          <option value="">Selecciona tipo</option>
          <option>Vacaciones</option>
          <option>D√≠a libre</option>
          <option>Asuntos propios</option>
        </select>

        <div class="row">
          <div style="flex:1">
            <label for="desde">Desde (fecha y hora)</label>
            <input id="desde" type="datetime-local" required>
          </div>
          <div style="flex:1">
            <label for="hasta">Hasta (fecha y hora)</label>
            <input id="hasta" type="datetime-local" required>
          </div>
        </div>

        <button type="button" id="todoDia" class="btn secondary">Todo el d√≠a</button>

        <label style="margin-top:12px;display:flex;align-items:center;gap:8px">
          <input id="notifyCheckbox" type="checkbox" style="transform:scale(1.1)"> Deseo recibir notificaci√≥n
        </label>

        <div id="emailWrap" style="display:none">
          <label for="email">Email (opcional, para notificaciones)</label>
          <input id="email" type="email" placeholder="tu@ejemplo.com">
        </div>

        <label for="comentarios">Comentarios (opcional)</label>
        <textarea id="comentarios" placeholder="Motivo, notas..."></textarea>

        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button id="submitBtn" class="btn" type="submit">Enviar solicitud</button>
          <button id="saveChangesBtn" class="btn" type="button" style="display:none">Guardar cambios</button>
          <button id="deleteBtn" class="btn secondary" type="button" style="display:none;background:#e2b7a1;color:var(--accent-dark)">Eliminar</button>
          <button id="cancelBtn" class="btn secondary" type="button">Cancelar</button>
        </div>

        <div style="margin-top:8px" class="small-muted">Tu solicitud ser√° enviada a RRHH para su gesti√≥n. Estado inicial: <strong>Pendiente</strong>.</div>
      </form>
    </div>
  </div>

  <!-- Admin modal -->
  <div id="adminModal" class="modal" aria-hidden="true">
    <div class="modal-content" style="max-width:420px">
      <span class="close" id="closeAdmin">&times;</span>
      <h2>Acceso administrador</h2>
      <p class="small-muted">Introduce la clave para ver todas las solicitudes.</p>
      <input id="adminPassword" type="password" placeholder="Clave administradora">
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="enterAdmin" class="btn">Entrar</button>
        <button id="closeAdminBtn" class="btn secondary">Cerrar</button>
      </div>
      <div id="adminMsg" style="margin-top:10px;color:#8a3d3d;font-weight:700;"></div>
    </div>
  </div>

  <!-- FullCalendar + EmailJS + SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
  /******************************************
   CONFIG: EmailJS (deja como tus datos reales)
  ******************************************/
  emailjs.init("Q6R8TiTO6mPO8Bzxt"); // Public Key (mant√©n tu key)
  const SERVICE_ID = "service_6wnk6kc";
  const TEMPLATE_ID = "template_lwbjymg";
  const RRHH_EMAIL = "am.fortuny@honestgreens.com";

  /******************************************
   CONSTANTES Y ESTADO
  ******************************************/
  const DIAS_VACACIONES_TOTALES = 30;
  const CALENDAR_START = '2025-10-01';
  const CALENDAR_END = '2026-12-31';
  const ADMIN_PASSWORD = 'sala2025';

  let isAdmin = false;
  let selectedDateISO = null;
  let selectedEventId = null;
  const empleadoSelect = document.getElementById('empleadoSelect');
  const diasRestantesEl = document.getElementById('diasRestantes');

  /******************************************
   STORAGE UTILITIES (key v4)
  ******************************************/
  function obtenerEventos() {
    const raw = localStorage.getItem('og_events_v4');
    try { return raw ? JSON.parse(raw) : []; } catch(e) { return []; }
  }
  function guardarEventos(evts) {
    localStorage.setItem('og_events_v4', JSON.stringify(evts));
  }

  function obtenerDiasPara(empleado) {
    if (!empleado) return DIAS_VACACIONES_TOTALES;
    const key = 'og_dias_' + empleado;
    const raw = localStorage.getItem(key);
    if (raw === null) {
      localStorage.setItem(key, String(DIAS_VACACIONES_TOTALES));
      return DIAS_VACACIONES_TOTALES;
    }
    return Number(raw);
  }
  function guardarDiasPara(empleado, dias) {
    if (!empleado) return;
    const key = 'og_dias_' + empleado;
    localStorage.setItem(key, String(Math.max(0, Number(dias))));
  }

  /******************************************
   Persist selected empleado
  ******************************************/
  const storedEmpleado = localStorage.getItem('empleadoSeleccionado');
  if (storedEmpleado) empleadoSelect.value = storedEmpleado;
  function actualizarContadorDisplay(empleado) {
    diasRestantesEl.textContent = obtenerDiasPara(empleado || empleadoSelect.value || storedEmpleado || '');
  }
  actualizarContadorDisplay(empleadoSelect.value || storedEmpleado || '');

  empleadoSelect.addEventListener('change', () => {
    const nombre = empleadoSelect.value;
    localStorage.setItem('empleadoSeleccionado', nombre);
    actualizarContadorDisplay(nombre);
    renderizarEventos();
  });

  /******************************************
   Inicializar FullCalendar
  ******************************************/
  const calendarEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    initialDate: CALENDAR_START,
    firstDay: 1, // lunes
    headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
    validRange: { start: CALENDAR_START, end: CALENDAR_END },
    height: 'auto',
    dateClick: function(info) {
      selectedEventId = null;
      selectedDateISO = info.dateStr;
      abrirModalConFecha(info.dateStr);
    },
    eventClick: function(info) {
      const evRaw = info.event.extendedProps && info.event.extendedProps.raw ? info.event.extendedProps.raw : null;
      if (evRaw && evRaw.id) abrirModalEdicion(evRaw.id);
    },
    events: []
  });
  calendar.render();

  /******************************************
   Modal controls and elements
  ******************************************/
  const modal = document.getElementById('modal');
  const closeModalBtn = document.getElementById('closeModal');
  const tipoInput = document.getElementById('tipo');
  const desdeInput = document.getElementById('desde');
  const hastaInput = document.getElementById('hasta');
  const comentariosInput = document.getElementById('comentarios');
  const todoDiaBtn = document.getElementById('todoDia');
  const form = document.getElementById('solicitudForm');
  const cancelBtn = document.getElementById('cancelBtn');
  const submitBtn = document.getElementById('submitBtn');
  const saveChangesBtn = document.getElementById('saveChangesBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  const modalTitle = document.getElementById('modalTitle');
  const notifyCheckbox = document.getElementById('notifyCheckbox');
  const emailWrap = document.getElementById('emailWrap');
  const emailInput = document.getElementById('email');

  notifyCheckbox.addEventListener('change', ()=> {
    emailWrap.style.display = notifyCheckbox.checked ? 'block' : 'none';
  });

  function abrirModalConFecha(fechaISO) {
    modal.style.display = 'flex';
    modalTitle.textContent = 'Solicitud de tiempo';
    desdeInput.value = fechaISO + 'T09:00';
    hastaInput.value = fechaISO + 'T18:00';
    tipoInput.value = '';
    comentariosInput.value = '';
    notifyCheckbox.checked = false;
    emailWrap.style.display = 'none';
    emailInput.value = '';
    selectedEventId = null;
    submitBtn.style.display = '';
    saveChangesBtn.style.display = 'none';
    deleteBtn.style.display = 'none';
    // remove admin action row if any
    const r = document.getElementById('adminActionRow'); if (r) r.remove();
  }

  function abrirModalEdicion(eventId) {
    const evts = obtenerEventos();
    const ev = evts.find(x => x.id === eventId);
    if (!ev) return alert('Evento no encontrado');
    selectedEventId = ev.id;
    modal.style.display = 'flex';
    modalTitle.textContent = `Solicitud ‚Äî ${ev.employee} (${ev.status})`;
    tipoInput.value = ev.type;
    desdeInput.value = ev.fromDate;
    hastaInput.value = ev.toDate;
    comentariosInput.value = ev.comments || '';
    notifyCheckbox.checked = !!ev.notifyEmail;
    emailWrap.style.display = notifyCheckbox.checked ? 'block' : 'none';
    emailInput.value = ev.email || '';
    submitBtn.style.display = 'none';
    saveChangesBtn.style.display = '';
    deleteBtn.style.display = '';
    // propietario solo puede editar/eliminar si es suyo y estado pendiente
    const current = empleadoSelect.value || localStorage.getItem('empleadoSeleccionado') || '';
    if (!isAdmin && ev.employee !== current) {
      saveChangesBtn.style.display = 'none';
      deleteBtn.style.display = 'none';
    } else if (!isAdmin && ev.status !== 'Pendiente') {
      saveChangesBtn.style.display = 'none';
      deleteBtn.style.display = 'none';
    }
    // add admin action buttons if admin
    actualizarBotonesAdminEnModal(ev);
  }

  function actualizarBotonesAdminEnModal(ev){
    const existControl = document.getElementById('adminActionRow');
    if (existControl) existControl.remove();
    if (!isAdmin) return;
    const row = document.createElement('div');
    row.id = 'adminActionRow';
    row.style.marginTop = '10px';
    row.style.display = 'flex';
    row.style.gap = '8px';
    row.innerHTML = `
      <button id="approveBtn" class="btn" type="button">Aprobar</button>
      <button id="rejectBtn" class="btn secondary" type="button" style="background:#f0c4c0;color:var(--accent-dark)">Rechazar</button>
      <div style="align-self:center;font-weight:700;color:${ev.status === 'Aprobada' ? 'var(--status-approved)' : ev.status === 'Rechazada' ? 'var(--status-rejected)' : 'var(--accent-dark)'};margin-left:10px">${ev.status}</div>
    `;
    document.querySelector('.modal-content form').appendChild(row);
    document.getElementById('approveBtn').addEventListener('click', ()=> accionAprobarRechazar(ev.id, 'Aprobada'));
    document.getElementById('rejectBtn').addEventListener('click', ()=> accionAprobarRechazar(ev.id, 'Rechazada'));
  }

  function cerrarModal() {
    modal.style.display = 'none';
    const r = document.getElementById('adminActionRow'); if (r) r.remove();
  }

  closeModalBtn.addEventListener('click', cerrarModal);
  cancelBtn.addEventListener('click', (e) => { e.preventDefault(); cerrarModal(); });
  window.addEventListener('click', (e) => { if (e.target === modal) cerrarModal(); });

  todoDiaBtn.addEventListener('click', () => {
    const desdeVal = desdeInput.value;
    if (!desdeVal) { alert('Selecciona primero una fecha (haz clic en un d√≠a).'); return; }
    const fecha = desdeVal.split('T')[0];
    desdeInput.value = fecha + 'T00:00';
    hastaInput.value = fecha + 'T23:59';
  });

  /******************************************
   Helpers: d√≠as inclusivos y colores
  ******************************************/
  function diasEntreInclusive(desdeISO, hastaISO) {
    const d1 = new Date(desdeISO);
    const d2 = new Date(hastaISO);
    const msDia = 1000 * 60 * 60 * 24;
    const diff = Math.floor((Date.UTC(d2.getFullYear(), d2.getMonth(), d2.getDate()) - Date.UTC(d1.getFullYear(), d1.getMonth(), d1.getDate())) / msDia) + 1;
    return diff;
  }
  function nextDateISO(ymd) {
    const d = new Date(ymd);
    d.setDate(d.getDate() + 1);
    return d.toISOString().split('T')[0];
  }
  function colorParaEvento(type, status){
    const base = (type === 'Vacaciones') ? getComputedStyle(document.documentElement).getPropertyValue('--vacaciones-dark').trim()
      : (type === 'D√≠a libre') ? getComputedStyle(document.documentElement).getPropertyValue('--libre-light').trim()
      : getComputedStyle(document.documentElement).getPropertyValue('--asuntos-mid').trim();
    const border = (status === 'Aprobada') ? getComputedStyle(document.documentElement).getPropertyValue('--status-approved').trim()
      : (status === 'Rechazada') ? getComputedStyle(document.documentElement).getPropertyValue('--status-rejected').trim()
      : '#b8926f';
    return { background: base, border: border };
  }

  /******************************************
   Render eventos en calendario (seg√∫n permisos)
  ******************************************/
  function renderizarEventos() {
    calendar.getEvents().forEach(ev => ev.remove());
    const evts = obtenerEventos();
    const empleadoActual = empleadoSelect.value || localStorage.getItem('empleadoSeleccionado') || '';
    evts.forEach(e => {
      if (!isAdmin && empleadoActual && e.employee !== empleadoActual) return;
      const allDay = e.allDay;
      const start = allDay ? e.fromDate.split('T')[0] : e.fromDate;
      const evTitle = isAdmin ? `${e.employee} ‚Äî ${e.type} (${e.status})` : `${e.employee}`;
      const colors = colorParaEvento(e.type, e.status);
      const fcEvent = {
        id: e.id,
        title: evTitle,
        start: start,
        end: allDay ? nextDateISO(e.toDate.split('T')[0]) : e.toDate,
        allDay: allDay,
        backgroundColor: colors.background,
        borderColor: colors.border,
        textColor: '#3d2f2a',
        extendedProps: { raw: e }
      };
      calendar.addEvent(fcEvent);
    });
    if (!isAdmin) actualizarContadorDisplay(empleadoSelect.value || storedEmpleado || '');
  }

  /******************************************
   Crear solicitud: guarda y notifica a RRHH
   - Si type === 'Vacaciones', descontar inmediatamente (no dejar negativo)
   - marcar campo `deducted: true` si se descont√≥
  ******************************************/
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    if (selectedEventId) return;

    const empleado = empleadoSelect.value;
    const tipo = tipoInput.value;
    const desde = desdeInput.value;
    const hasta = hastaInput.value;
    const comentarios = comentariosInput.value || '';
    const notify = notifyCheckbox.checked;
    const email = (notify && emailInput.value) ? emailInput.value.trim() : '';

    if (!empleado) { alert('Por favor selecciona tu nombre.'); return; }
    if (!tipo) { alert('Por favor selecciona tipo de solicitud.'); return; }
    if (!desde || !hasta) { alert('Por favor selecciona desde y hasta.'); return; }

    const diasSolicitados = diasEntreInclusive(desde, hasta);
    const disponibles = obtenerDiasPara(empleado);

    if (tipo === 'Vacaciones' && diasSolicitados > disponibles) {
      if (!confirm(`Atenci√≥n: ${empleado} solo tiene ${disponibles} d√≠as disponibles. ¬øDeseas enviar la solicitud de todos modos?`)) return;
    }

    const allDay = (desde.endsWith('T00:00') && (hasta.endsWith('T23:59') || hasta.endsWith('T24:00')));
    const id = 'evt_' + Date.now();
    const newEvent = {
      id,
      employee: empleado,
      type: tipo,
      fromDate: desde,
      toDate: hasta,
      comments: comentarios,
      days: diasSolicitados,
      allDay: allDay,
      createdAt: new Date().toISOString(),
      status: 'Pendiente',
      notifyEmail: !!email,
      email: email || '',
      deducted: false // si aplicamos descuento lo marcamos true
    };

    // Si es Vacaciones, descontar inmediatamente (seg√∫n petici√≥n)
    if (tipo === 'Vacaciones') {
      const actuales = obtenerDiasPara(empleado);
      const nuevos = Math.max(0, actuales - diasSolicitados);
      guardarDiasPara(empleado, nuevos);
      newEvent.deducted = true;
    }

    // Enviar correo a RRHH notificando nueva solicitud
    const asunto = `[Solicitud: ${tipo}] ${empleado} ‚Äî del ${desde.split('T')[0]} al ${hasta.split('T')[0]}`;
    const params = {
      employee: empleado,
      type: tipo,
      from_date: desde,
      to_date: hasta,
      comments: comentarios,
      days_requested: diasSolicitados,
      days_remaining_before: obtenerDiasPara(empleado) + (newEvent.deducted ? diasSolicitados : 0),
      all_day: newEvent.allDay ? "S√≠" : "No",
      subject: asunto,
      to_email: RRHH_EMAIL
    };

    emailjs.send(SERVICE_ID, TEMPLATE_ID, params)
      .then(() => {
        const evts = obtenerEventos();
        evts.push(newEvent);
        guardarEventos(evts);
        renderizarEventos();
        alert('‚úÖ Solicitud enviada y marcada como PENDIENTE. Gracias, ' + empleado + '.');
        cerrarModal();
        form.reset();
      })
      .catch((err) => {
        console.error('EmailJS error:', err);
        // Si fallo el env√≠o de correo a RRHH, revertimos descuento si lo aplicamos
        if (newEvent.deducted) {
          const actuales = obtenerDiasPara(empleado);
          guardarDiasPara(empleado, actuales + diasSolicitados);
        }
        alert('‚ùå Error al notificar a RRHH. La solicitud no fue guardada.');
      });
  });

  /******************************************
   Guardar cambios sobre solicitud existente
   - Solo propietarios en estado Pendiente pueden editar (admin puede siempre)
   - Si event.deducted true (se descont√≥ antes), ajustamos d√≠as restantes en funci√≥n del delta
  ******************************************/
  saveChangesBtn.addEventListener('click', () => {
    if (!selectedEventId) return;
    const evts = obtenerEventos();
    const idx = evts.findIndex(x=>x.id===selectedEventId);
    if (idx === -1) return alert('Evento no encontrado.');

    const tipo = tipoInput.value;
    const desde = desdeInput.value;
    const hasta = hastaInput.value;
    const comentarios = comentariosInput.value || '';
    const notify = notifyCheckbox.checked;
    const email = (notify && emailInput.value) ? emailInput.value.trim() : '';

    if (!tipo || !desde || !hasta) { alert('Rellena tipo, desde y hasta.'); return; }

    const diasSolicitados = diasEntreInclusive(desde, hasta);
    const ev = evts[idx];

    // si antes se hab√≠a descontado (evento.deducted === true), ajustamos d√≠as restantes:
    if (ev.deducted) {
      const actuales = obtenerDiasPara(ev.employee);
      // actuales ya reflejan la deducci√≥n hecha inicialmente, por eso para recalcular:
      // revertimos la deducci√≥n original y aplicamos la nueva
      const revert = actuales + ev.days;
      const reaplicar = Math.max(0, revert - (tipo === 'Vacaciones' ? diasSolicitados : 0));
      guardarDiasPara(ev.employee, reaplicar);
      ev.deducted = (tipo === 'Vacaciones');
    } else {
      // si antes no se descont√≥, pero ahora pasa a Vacaciones y estamos permitidos a descontar
      if (!ev.deducted && tipo === 'Vacaciones') {
        const actuales = obtenerDiasPara(ev.employee);
        const nuevos = Math.max(0, actuales - diasSolicitados);
        guardarDiasPara(ev.employee, nuevos);
        ev.deducted = true;
      }
    }

    // actualizar campos
    ev.type = tipo;
    ev.fromDate = desde;
    ev.toDate = hasta;
    ev.comments = comentarios;
    ev.days = diasSolicitados;
    ev.notifyEmail = notify;
    ev.email = email || '';

    guardarEventos(evts);
    renderizarEventos();
    alert('Cambios guardados.');
    cerrarModal();
  });

  /******************************************
   Eliminar solicitud
   - Confirmaci√≥n
   - Si el evento ten√≠a deducci√≥n aplicada, restaurar d√≠as
  ******************************************/
  deleteBtn.addEventListener('click', () => {
    if (!selectedEventId) return;
    if (!confirm('¬øSeguro que quieres eliminar esta solicitud?')) return;
    const evts = obtenerEventos();
    const idx = evts.findIndex(x=>x.id===selectedEventId);
    if (idx === -1) return alert('Evento no encontrado.');
    const ev = evts[idx];
    // si deducci√≥n aplicada (ya rest√≥ d√≠as), restauramos
    if (ev.deducted) {
      const actuales = obtenerDiasPara(ev.employee);
      guardarDiasPara(ev.employee, actuales + ev.days);
    }
    evts.splice(idx,1);
    guardarEventos(evts);
    renderizarEventos();
    alert('Solicitud eliminada.');
    cerrarModal();
  });

  /******************************************
   Acciones ADMIN: aprobar/rechazar
   - Si se rechaza y hubo deducci√≥n, restauramos
   - Si se aprueba y no hubo deducci√≥n pero type === 'Vacaciones', aplicamos deducci√≥n (por si no se aplic√≥ antes)
   - Enviamos notificaci√≥n al solicitante si dej√≥ email
  ******************************************/
  function accionAprobarRechazar(eventId, nuevoStatus) {
    const evts = obtenerEventos();
    const idx = evts.findIndex(x=>x.id===eventId);
    if (idx === -1) { alert('Evento no encontrado'); return; }
    const ev = evts[idx];

    // si rechazamos y ya se hab√≠a descontado, restaurar
    if (nuevoStatus === 'Rechazada' && ev.deducted) {
      const actuales = obtenerDiasPara(ev.employee);
      guardarDiasPara(ev.employee, actuales + ev.days);
      ev.deducted = false;
    }

    // si aprobamos y no se descont√≥ (por alguna raz√≥n), aplicar descuento si Vacaciones
    if (nuevoStatus === 'Aprobada' && !ev.deducted && ev.type === 'Vacaciones') {
      const actuales = obtenerDiasPara(ev.employee);
      const nuevos = Math.max(0, actuales - ev.days);
      guardarDiasPara(ev.employee, nuevos);
      ev.deducted = true;
    }

    ev.status = nuevoStatus;
    guardarEventos(evts);
    renderizarEventos();
    cerrarModal();

    // preparar parametros para EmailJS
    const asunto = `Tu solicitud (${ev.type}) ha sido ${nuevoStatus.toLowerCase()}`;
    const params = {
      employee: ev.employee,
      type: ev.type,
      from_date: ev.fromDate,
      to_date: ev.toDate,
      comments: ev.comments || '',
      days_requested: ev.days,
      status: ev.status,
      subject: asunto,
      to_email: RRHH_EMAIL
    };

    // Enviar a RRHH (registro) y, si el empleado dej√≥ email, enviarle notificaci√≥n tambi√©n
    emailjs.send(SERVICE_ID, TEMPLATE_ID, params)
      .then(() => {
        if (ev.notifyEmail && ev.email) {
          // enviar notificaci√≥n al empleado (puede usar la misma plantilla con distinto asunto/params)
          const paramsEmp = {
            ...params,
            to_email: ev.email,
            subject: asunto + ' - Sala FORTUNY',
            note: `Notificaci√≥n enviada al empleado ${ev.email}`
          };
          return emailjs.send(SERVICE_ID, TEMPLATE_ID, paramsEmp)
            .then(()=> {
              alert(`Solicitud ${nuevoStatus.toLowerCase()} y notificaci√≥n enviada al empleado (${ev.email}).`);
            })
            .catch(err => {
              console.error('Error env√≠o a empleado:', err);
              alert(`Estado cambiado a ${nuevoStatus.toLowerCase()} pero no se pudo enviar notificaci√≥n al empleado.`);
            });
        } else {
          alert(`Solicitud ${nuevoStatus.toLowerCase()} y notificaci√≥n enviada a RRHH.`);
        }
      })
      .catch(err => {
        console.error('Error notificaci√≥n RRHH:', err);
        alert(`Estado cambiado a ${nuevoStatus.toLowerCase()} pero hubo un error notificando a RRHH.`);
      });
  }

  /******************************************
   ADMIN: UI, export, panel
  ******************************************/
  const adminBtn = document.getElementById('adminBtn');
  const adminModal = document.getElementById('adminModal');
  const closeAdmin = document.getElementById('closeAdmin');
  const closeAdminBtn = document.getElementById('closeAdminBtn');
  const enterAdminBtn = document.getElementById('enterAdmin');
  const adminPasswordInput = document.getElementById('adminPassword');
  const adminMsg = document.getElementById('adminMsg');

  adminBtn.addEventListener('click', () => {
    adminModal.style.display = 'flex';
    adminPasswordInput.value = '';
    adminMsg.textContent = '';
  });
  closeAdmin.addEventListener('click', () => adminModal.style.display = 'none');
  closeAdminBtn.addEventListener('click', () => adminModal.style.display = 'none');
  enterAdminBtn.addEventListener('click', () => {
    const val = adminPasswordInput.value.trim();
    if (val === ADMIN_PASSWORD) {
      isAdmin = true;
      localStorage.setItem('og_admin', '1');
      adminModal.style.display = 'none';
      alert('üîí Modo administrador activado. Ahora ves todas las solicitudes.');
      mostrarVistaAdmin();
    } else {
      adminMsg.textContent = 'Clave incorrecta';
    }
  });

  if (localStorage.getItem('og_admin') === '1') {
    isAdmin = true;
    mostrarVistaAdmin();
  }

  function mostrarVistaAdmin() {
    document.getElementById('contador').innerHTML = 'Modo administrador ‚Äî <button id="salirAdmin" class="btn secondary">Salir</button>';
    const salirBtn = document.getElementById('salirAdmin');
    salirBtn.addEventListener('click', () => {
      isAdmin = false;
      localStorage.removeItem('og_admin');
      actualizarContadorDisplay(empleadoSelect.value || '');
      renderizarEventos();
      location.reload();
    });

    const adminPanel = document.createElement('div');
    adminPanel.style.marginTop = '10px';
    adminPanel.style.padding = '10px';
    adminPanel.style.background = 'linear-gradient(90deg,#fffaf5,#fff)';
    adminPanel.style.borderRadius = '8px';
    adminPanel.style.boxShadow = '0 4px 8px rgba(0,0,0,0.04)';
    adminPanel.innerHTML = `
      <div style="font-weight:700;color:var(--accent-dark);margin-bottom:8px">Panel administrador</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="verTodos" class="btn secondary">Ver historial (tabla)</button>
        <button id="reiniciarDias" class="btn">Reiniciar d√≠as a 30</button>
        <button id="descargarCSV" class="btn secondary">Exportar CSV</button>
        <button id="exportXLSX" class="btn">Exportar Excel (.xlsx)</button>
      </div>
      <div id="adminTableWrap" style="margin-top:12px"></div>
    `;
    document.querySelector('.wrap').insertBefore(adminPanel, document.getElementById('calendar'));

    document.getElementById('verTodos').addEventListener('click', mostrarTablaAdmin);
    document.getElementById('reiniciarDias').addEventListener('click', () => {
      if (!confirm('¬øSeguro que quieres reiniciar los d√≠as de todos a 30?')) return;
      const empleados = Array.from(empleadoSelect.options).map(o => o.value).filter(v => v);
      empleados.forEach(emp => guardarDiasPara(emp, DIAS_VACACIONES_TOTALES));
      alert('D√≠as reiniciados.');
      actualizarContadorDisplay(empleadoSelect.value || '');
    });
    document.getElementById('descargarCSV').addEventListener('click', exportarCSV);
    document.getElementById('exportXLSX').addEventListener('click', exportarXLSX);
    renderizarEventos();
  }

  function mostrarTablaAdmin() {
    const wrap = document.getElementById('adminTableWrap');
    const evts = obtenerEventos();
    if (!evts.length) { wrap.innerHTML = '<div class="small-muted">No hay solicitudes</div>'; return; }
    let html = '<table class="admin-table"><thead><tr><th>Empleado</th><th>Tipo</th><th>Desde</th><th>Hasta</th><th>D√≠as</th><th>Estado</th><th>Email</th><th>Comentarios</th><th>Acciones</th></tr></thead><tbody>';
    evts.forEach(ev => {
      html += `<tr>
        <td>${ev.employee}</td>
        <td>${ev.type}</td>
        <td>${ev.fromDate.replace('T',' ')}</td>
        <td>${ev.toDate.replace('T',' ')}</td>
        <td>${ev.days}</td>
        <td style="font-weight:700;color:${ev.status === 'Aprobada' ? 'var(--status-approved)' : ev.status === 'Rechazada' ? 'var(--status-rejected)' : 'var(--accent-dark)'}">${ev.status}</td>
        <td>${ev.email || ''}</td>
        <td>${(ev.comments||'')}</td>
        <td><button class="btn small" data-id="${ev.id}" style="padding:6px 8px;font-size:0.85rem">Abrir</button></td>
      </tr>`;
    });
    html += '</tbody></table>';
    wrap.innerHTML = html;
    wrap.querySelectorAll('button[data-id]').forEach(b=>{
      b.addEventListener('click', ()=> abrirModalEdicion(b.getAttribute('data-id')));
    });
  }

  function exportarCSV() {
    const evts = obtenerEventos();
    if (!evts.length) { alert('No hay datos para exportar'); return; }
    const rows = [['Empleado','Tipo','Desde','Hasta','D√≠as','Estado','Email','Comentarios','Creado']];
    evts.forEach(e => rows.push([e.employee, e.type, e.fromDate, e.toDate, e.days, e.status, e.email || '', (e.comments||''), e.createdAt]));
    const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'solicitudes_organizador_fortuny.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

  function exportarXLSX() {
    const evts = obtenerEventos();
    if (!evts.length) { alert('No hay datos para exportar'); return; }
    const rows = evts.map(e => ({
      Empleado: e.employee,
      Tipo: e.type,
      Desde: e.fromDate,
      Hasta: e.toDate,
      Dias: e.days,
      Estado: e.status,
      Email: e.email || '',
      Comentarios: e.comments || '',
      Creado: e.createdAt
    }));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Solicitudes');
    XLSX.writeFile(wb, 'solicitudes_organizador_fortuny.xlsx');
  }

  /******************************************
   Inicial render
  ******************************************/
  renderizarEventos();

  </script>
</body>
</html>
