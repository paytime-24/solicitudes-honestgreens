<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sala - FORTUNY</title>

  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />

  <style>
    :root{
      --bg:#f6f1ea;
      --panel:#fffefc;
      --accent:#a86f3f;
      --accent-dark:#7e4e2d;
      /* script.js - Lógica para Sala FORTUNY (modo lectura JSON local)
   - FullCalendar
   - EmailJS (notificaciones)
   - Panel ADMIN con acordeón por empleado y export/import JSON (descarga/lectura)
   - Export XLSX con SheetJS
   - Nota: El archivo data/solicitudes.json se carga en lectura; los cambios se guardan en localStorage.
*/

/* CONFIG EMAILJS: reemplaza por tus datos */
emailjs.init("Q6R8TiTO6mPO8Bzxt"); // public key
const SERVICE_ID = "service_6wnk6kc";
const TEMPLATE_ID = "template_lwbjymg";
const RRHH_EMAIL = "am.fortuny@honestgreens.com";

/* Constantes */
const DIAS_VACACIONES_TOTALES = 30;
const CALENDAR_START = '2025-10-01';
const CALENDAR_END = '2026-12-31';
const ADMIN_PASSWORD = 'sala2025';

/* Estado */
let isAdmin = false;
let selectedEventId = null;
let selectedDateISO = null;

/* Elementos DOM */
const empleadoSelect = document.getElementById('empleadoSelect');
const diasRestantesEl = document.getElementById('diasRestantes');
const employeesList = document.getElementById('employeesList');

const modal = document.getElementById('modal');
const closeModalBtn = document.getElementById('closeModal');
const tipoInput = document.getElementById('tipo');
const desdeInput = document.getElementById('desde');
const hastaInput = document.getElementById('hasta');
const comentariosInput = document.getElementById('comentarios');
const notifyCheckbox = document.getElementById('notifyCheckbox');
const emailWrap = document.getElementById('emailWrap');
const emailInput = document.getElementById('email');
const form = document.getElementById('solicitudForm');
const submitBtn = document.getElementById('submitBtn');
const saveChangesBtn = document.getElementById('saveChangesBtn');
const deleteBtn = document.getElementById('deleteBtn');
const cancelBtn = document.getElementById('cancelBtn');

const adminBtn = document.getElementById('adminBtn');
const adminModal = document.getElementById('adminModal');
const closeAdmin = document.getElementById('closeAdmin');
const closeAdminBtn = document.getElementById('closeAdminBtn');
const enterAdminBtn = document.getElementById('enterAdmin');
const adminPasswordInput = document.getElementById('adminPassword');
const adminMsg = document.getElementById('adminMsg');

const verTodosBtn = document.getElementById('verTodosBtn');
const reiniciarDiasBtn = document.getElementById('reiniciarDiasBtn');
const exportXlsxBtn = document.getElementById('exportXlsxBtn');
const exportJsonBtn = document.getElementById('exportJsonBtn');
const importJsonInput = document.getElementById('importJsonInput');

/* Storage helpers (localStorage primary for write operations) */
function obtenerEventos() {
  const raw = localStorage.getItem('og_events_json_v1');
  try { return raw ? JSON.parse(raw) : []; } catch(e){ return []; }
}
function guardarEventos(evts) {
  localStorage.setItem('og_events_json_v1', JSON.stringify(evts));
  window.dispatchEvent(new CustomEvent('data:changed'));
}
function obtenerDiasPara(empleado) {
  if (!empleado) return DIAS_VACACIONES_TOTALES;
  const key = 'og_dias_json_' + empleado;
  const raw = localStorage.getItem(key);
  if (raw === null) {
    localStorage.setItem(key, String(DIAS_VACACIONES_TOTALES));
    return DIAS_VACACIONES_TOTALES;
  }
  return Number(raw);
}
function guardarDiasPara(empleado, dias) {
  if (!empleado) return;
  const key = 'og_dias_json_' + empleado;
  localStorage.setItem(key, String(Math.max(0, Number(dias))));
  window.dispatchEvent(new CustomEvent('data:changed'));
}

/* Load initial data from data/solicitudes.json (read-only) into localStorage if empty */
async function cargarJSONInicial() {
  try {
    const resp = await fetch('./data/solicitudes.json', {cache: "no-store"});
    if (!resp.ok) {
      console.warn('No se encontró data/solicitudes.json, usando localStorage en blanco.');
      return;
    }
    const payload = await resp.json();
    if (payload && Array.isArray(payload.events) && payload.events.length) {
      // Only populate localStorage if empty
      const current = obtenerEventos();
      if (!current || current.length === 0) {
        guardarEventos(payload.events);
        // set days if provided
        if (payload.days && typeof payload.days === 'object') {
          Object.keys(payload.days).forEach(k => guardarDiasPara(k, payload.days[k]));
        }
        console.log('Datos iniciales cargados desde data/solicitudes.json');
      } else {
        console.log('localStorage ya contiene eventos; no se sobreescribe con JSON inicial.');
      }
    }
  } catch(err) {
    console.error('Error cargando JSON inicial:', err);
  }
}

/* Persist selected employee */
const storedEmpleado = localStorage.getItem('empleadoSeleccionado');
if (storedEmpleado) empleadoSelect.value = storedEmpleado;
function actualizarContadorDisplay(empleado) {
  diasRestantesEl.textContent = obtenerDiasPara(empleado || empleadoSelect.value || storedEmpleado || '');
}
actualizarContadorDisplay(empleadoSelect.value || storedEmpleado || '');
empleadoSelect.addEventListener('change', () => {
  const nombre = empleadoSelect.value;
  localStorage.setItem('empleadoSeleccionado', nombre);
  actualizarContadorDisplay(nombre);
  renderizarEventos();
});

/* FullCalendar init */
const calendarEl = document.getElementById('calendar');
const calendar = new FullCalendar.Calendar(calendarEl, {
  initialView: 'dayGridMonth',
  initialDate: CALENDAR_START,
  firstDay:1,
  headerToolbar: { left:'prev,next today', center:'title', right:''},
  validRange: { start: CALENDAR_START, end: CALENDAR_END },
  height: 'auto',
  dateClick: function(info){
    selectedEventId = null;
    selectedDateISO = info.dateStr;
    abrirModalConFecha(info.dateStr);
  },
  eventClick: function(info){
    const evRaw = info.event.extendedProps && info.event.extendedProps.raw ? info.event.extendedProps.raw : null;
    if (evRaw && evRaw.id) abrirModalEdicion(evRaw.id);
  },
  events:[]
});
calendar.render();

/* Modal handling */
notifyCheckbox.addEventListener('change', ()=> {
  emailWrap.style.display = notifyCheckbox.checked ? 'block' : 'none';
});
function abrirModalConFecha(fechaISO){
  modal.style.display = 'flex';
  document.getElementById('modalTitle').textContent = 'Nueva solicitud';
  desdeInput.value = fechaISO + 'T09:00';
  hastaInput.value = fechaISO + 'T18:00';
  tipoInput.value = '';
  comentariosInput.value = '';
  notifyCheckbox.checked = false;
  emailWrap.style.display = 'none';
  emailInput.value = '';
  selectedEventId = null;
  submitBtn.style.display = '';
  saveChangesBtn.style.display = 'none';
  deleteBtn.style.display = 'none';
}
function abrirModalEdicion(eventId){
  const evts = obtenerEventos();
  const ev = evts.find(x=>x.id===eventId);
  if (!ev) return alert('Evento no encontrado');
  selectedEventId = ev.id;
  modal.style.display = 'flex';
  document.getElementById('modalTitle').textContent = `Solicitud — ${ev.employee} (${ev.status})`;
  tipoInput.value = ev.type;
  desdeInput.value = ev.fromDate;
  hastaInput.value = ev.toDate;
  comentariosInput.value = ev.comments || '';
  notifyCheckbox.checked = !!ev.notifyEmail;
  emailWrap.style.display = notifyCheckbox.checked ? 'block' : 'none';
  emailInput.value = ev.email || '';
  submitBtn.style.display = 'none';
  saveChangesBtn.style.display = '';
  deleteBtn.style.display = '';
  actualizarBotonesAdminEnModal(ev);
}
function actualizarBotonesAdminEnModal(ev){
  const exist = document.getElementById('adminActionRow');
  if (exist) exist.remove();
  if (!isAdmin) return;
  const row = document.createElement('div');
  row.id = 'adminActionRow';
  row.style.marginTop = '10px';
  row.style.display = 'flex';
  row.style.gap = '8px';
  row.innerHTML = `<button id="approveBtn" class="action-btn action-approve">Aprobar</button>
                   <button id="rejectBtn" class="action-btn action-reject">Rechazar</button>
                   <div style="align-self:center;font-weight:700;margin-left:8px;color:${ev.status==='Aprobada' ? 'var(--status-approved)' : ev.status==='Rechazada' ? 'var(--status-rejected)' : 'var(--accent-dark)'}">${ev.status}</div>`;
  document.querySelector('.modal-content form').appendChild(row);
  document.getElementById('approveBtn').addEventListener('click', ()=> accionAprobarRechazar(ev.id,'Aprobada'));
  document.getElementById('rejectBtn').addEventListener('click', ()=> accionAprobarRechazar(ev.id,'Rechazada'));
}
function cerrarModal(){ modal.style.display='none'; const r=document.getElementById('adminActionRow'); if(r) r.remove(); }
closeModalBtn.addEventListener('click', cerrarModal);
cancelBtn.addEventListener('click',(e)=>{ e.preventDefault(); cerrarModal(); });
window.addEventListener('click', (e)=> { if(e.target===modal) cerrarModal(); });

/* Helpers */
function diasEntreInclusive(desdeISO,hastaISO){
  const d1=new Date(desdeISO), d2=new Date(hastaISO);
  const msDia=1000*60*60*24;
  return Math.floor((Date.UTC(d2.getFullYear(),d2.getMonth(),d2.getDate()) - Date.UTC(d1.getFullYear(),d1.getMonth(),d1.getDate()))/msDia)+1;
}
function nextDateISO(ymd){
  const d=new Date(ymd); d.setDate(d.getDate()+1); return d.toISOString().split('T')[0];
}
function colorParaEvento(type,status){
  const base = (type==='Vacaciones') ? getComputedStyle(document.documentElement).getPropertyValue('--vacaciones-dark').trim()
             : (type==='Día libre') ? getComputedStyle(document.documentElement).getPropertyValue('--libre-light').trim()
             : getComputedStyle(document.documentElement).getPropertyValue('--asuntos-mid').trim();
  const border = (status==='Aprobada') ? getComputedStyle(document.documentElement).getPropertyValue('--status-approved').trim()
               : (status==='Rechazada') ? getComputedStyle(document.documentElement).getPropertyValue('--status-rejected').trim()
               : '#b8926f';
  return { background: base, border: border };
}

/* Render events & employees */
function renderizarEventos(){
  calendar.getEvents().forEach(ev=>ev.remove());
  const evts=obtenerEventos();
  const empleadoActual = empleadoSelect.value || localStorage.getItem('empleadoSeleccionado') || '';
  evts.forEach(e=>{
    if(!isAdmin && empleadoActual && e.employee!==empleadoActual) return;
    const allDay = e.allDay;
    const start = allDay ? e.fromDate.split('T')[0] : e.fromDate;
    const evTitle = isAdmin ? `${e.employee} — ${e.type} (${e.status})` : `${e.employee}`;
    const colors = colorParaEvento(e.type,e.status);
    const fcEvent = {
      id: e.id,
      title: evTitle,
      start: start,
      end: allDay ? nextDateISO(e.toDate.split('T')[0]) : e.toDate,
      allDay: allDay,
      backgroundColor: colors.background,
      borderColor: colors.border,
      textColor: '#3d2f2a',
      extendedProps:{raw:e}
    };
    calendar.addEvent(fcEvent);
  });
  renderEmployeesPanel();
  if(!isAdmin) actualizarContadorDisplay(empleadoSelect.value || storedEmpleado || '');
}

/* Employees panel */
function getAllEmployees() {
  return Array.from(empleadoSelect.options).map(o=>o.value).filter(v=>v);
}
function renderEmployeesPanel(){
  const empleados = getAllEmployees();
  employeesList.innerHTML = '';
  empleados.forEach(emp=>{
    const dias = obtenerDiasPara(emp);
    const card = document.createElement('div');
    card.className = 'card-emp';
    card.innerHTML = `<div class="emp-head">
        <div>
          <div class="emp-name">${emp}</div>
          <div style="font-size:0.86rem;color:#7a6a5d">Vacaciones restantes</div>
        </div>
        <div style="text-align:right">
          <div class="emp-days">${dias}d</div>
          <div style="margin-top:8px"><button class="btn-mini" data-emp="${emp}">Ver solicitudes</button></div>
        </div>
      </div>
      <div class="accordion-content" id="acc-${emp.replace(/\s/g,'_')}">
      </div>`;
    employeesList.appendChild(card);

    const btn = card.querySelector('button[data-emp]');
    btn.addEventListener('click', ()=> toggleAccordion(emp));
  });
}

function toggleAccordion(emp){
  const el = document.getElementById(`acc-${emp.replace(/\s/g,'_')}`);
  if(!el) return;
  if(el.style.display === 'block') { el.style.display = 'none'; return; }
  renderEmployeeRequests(emp, el);
  el.style.display = 'block';
}

function renderEmployeeRequests(emp, containerEl){
  const evts = obtenerEventos().filter(e=>e.employee===emp);
  if(!evts.length) { containerEl.innerHTML = '<div class="small-muted">No hay solicitudes</div>'; return; }
  let html = `<table class="admin-table"><thead><tr><th>Tipo</th><th>Desde</th><th>Hasta</th><th>Días</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>`;
  evts.forEach(ev=>{
    html += `<tr>
      <td>${ev.type}</td>
      <td>${ev.fromDate.replace('T',' ')}</td>
      <td>${ev.toDate.replace('T',' ')}</td>
      <td>${ev.days}</td>
      <td style="font-weight:700;color:${ev.status==='Aprobada' ? 'var(--status-approved)' : ev.status==='Rechazada' ? 'var(--status-rejected)' : 'var(--accent-dark)'}">${ev.status}</td>
      <td>
        <button class="action-btn action-edit" data-id="${ev.id}">Editar</button>
        <button class="action-btn action-approve" data-id="${ev.id}">Aprobar</button>
        <button class="action-btn action-reject" data-id="${ev.id}">Rechazar</button>
        <button class="action-btn action-delete" data-id="${ev.id}">Eliminar</button>
      </td>
    </tr>`;
  });
  html += '</tbody></table>';
  containerEl.innerHTML = html;

  containerEl.querySelectorAll('.action-edit').forEach(b=> b.addEventListener('click', ()=> abrirModalEdicion(b.dataset.id)));
  containerEl.querySelectorAll('.action-approve').forEach(b=> b.addEventListener('click', ()=> accionAprobarRechazar(b.dataset.id,'Aprobada')));
  containerEl.querySelectorAll('.action-reject').forEach(b=> b.addEventListener('click', ()=> accionAprobarRechazar(b.dataset.id,'Rechazada')));
  containerEl.querySelectorAll('.action-delete').forEach(b=> b.addEventListener('click', ()=> {
    if(!confirm('¿Seguro que quieres eliminar esta solicitud?')) return;
    eliminarSolicitudPorId(b.dataset.id);
  }));
}

/* Create request */
form.addEventListener('submit', function(e){
  e.preventDefault();
  if(selectedEventId) return;
  const empleado = empleadoSelect.value;
  const tipo = tipoInput.value;
  const desde = desdeInput.value;
  const hasta = hastaInput.value;
  const comentarios = comentariosInput.value || '';
  const notify = notifyCheckbox.checked;
  const email = (notify && emailInput.value) ? emailInput.value.trim() : '';

  if(!empleado) { alert('Selecciona tu nombre.'); return; }
  if(!tipo) { alert('Selecciona tipo.'); return; }
  if(!desde || !hasta) { alert('Selecciona desde y hasta.'); return; }

  const diasSolicitados = diasEntreInclusive(desde,hasta);
  const disponibles = obtenerDiasPara(empleado);

  if(tipo==='Vacaciones' && diasSolicitados > disponibles){
    if(!confirm(`Atención: ${empleado} solo tiene ${disponibles} días disponibles. ¿Enviar de todos modos?`)) return;
  }

  const allDay = (desde.endsWith('T00:00') && (hasta.endsWith('T23:59') || hasta.endsWith('T24:00')));
  const id = 'evt_'+Date.now();
  const newEvent = {
    id, employee: empleado, type: tipo, fromDate: desde, toDate: hasta,
    comments: comentarios, days: diasSolicitados, allDay, createdAt: new Date().toISOString(),
    status:'Pendiente', notifyEmail: !!email, email: email || '', deducted:false
  };

  if(tipo==='Vacaciones') {
    const actuales = obtenerDiasPara(empleado);
    const nuevos = Math.max(0, actuales - diasSolicitados);
    guardarDiasPara(empleado, nuevos);
    newEvent.deducted = true;
  }

  const asunto = `[Solicitud] ${empleado} - ${tipo} (${newEvent.fromDate.split('T')[0]} → ${newEvent.toDate.split('T')[0]})`;
  const params = {
    employee: empleado, type: tipo, from_date: newEvent.fromDate, to_date: newEvent.toDate,
    comments: newEvent.comments, days_requested: newEvent.days,
    days_remaining_before: obtenerDiasPara(empleado) + (newEvent.deducted ? newEvent.days : 0),
    all_day: newEvent.allDay ? "Sí":"No", subject: asunto, to_email: RRHH_EMAIL
  };
  emailjs.send(SERVICE_ID, TEMPLATE_ID, params)
    .then(()=> {
      const evts = obtenerEventos();
      evts.push(newEvent);
      guardarEventos(evts);
      renderizarEventos();
      alert('Solicitud enviada y marcada como PENDIENTE.');
      cerrarModal();
      form.reset();
    })
    .catch(err=>{
      console.error('EmailJS error:',err);
      if(newEvent.deducted){
        const actuales = obtenerDiasPara(empleado);
        guardarDiasPara(empleado, actuales + newEvent.days);
      }
      alert('Error notificando a RRHH. No se guardó la solicitud.');
    });
});

/* Save changes */
saveChangesBtn.addEventListener('click', ()=>{
  if(!selectedEventId) return;
  const evts = obtenerEventos();
  const idx = evts.findIndex(x=>x.id===selectedEventId);
  if(idx===-1) return alert('Evento no encontrado.');
  const ev = evts[idx];

  const tipo = tipoInput.value;
  const desde = desdeInput.value;
  const hasta = hastaInput.value;
  const comentarios = comentariosInput.value || '';
  const notify = notifyCheckbox.checked;
  const email = (notify && emailInput.value) ? emailInput.value.trim() : '';

  if(!tipo || !desde || !hasta) { alert('Rellena tipo, desde y hasta.'); return; }
  const diasSolicitados = diasEntreInclusive(desde,hasta);

  if(ev.deducted){
    const actuales = obtenerDiasPara(ev.employee);
    const reverted = actuales + ev.days;
    const reaplicar = Math.max(0, reverted - (tipo==='Vacaciones' ? diasSolicitados : 0));
    guardarDiasPara(ev.employee, reaplicar);
    ev.deducted = (tipo==='Vacaciones');
  } else {
    if(!ev.deducted && tipo==='Vacaciones'){
      const actuales = obtenerDiasPara(ev.employee);
      const nuevos = Math.max(0, actuales - diasSolicitados);
      guardarDiasPara(ev.employee, nuevos);
      ev.deducted = true;
    }
  }

  ev.type = tipo; ev.fromDate = desde; ev.toDate = hasta; ev.comments = comentarios; ev.days = diasSolicitados;
  ev.notifyEmail = notify; ev.email = email || '';
  guardarEventos(evts);
  renderizarEventos();
  alert('Cambios guardados.');
  cerrarModal();
});

/* Delete */
function eliminarSolicitudPorId(id){
  const evts = obtenerEventos();
  const idx = evts.findIndex(x=>x.id===id);
  if(idx===-1) return alert('No encontrado');
  const ev = evts[idx];
  if(ev.deducted){
    const actuales = obtenerDiasPara(ev.employee);
    guardarDiasPara(ev.employee, actuales + ev.days);
  }
  evts.splice(idx,1);
  guardarEventos(evts);
  renderizarEventos();
  alert('Solicitud eliminada.');
  cerrarModal();
}
deleteBtn.addEventListener('click', ()=>{
  if(!selectedEventId) return;
  if(!confirm('¿Seguro que quieres eliminar esta solicitud?')) return;
  eliminarSolicitudPorId(selectedEventId);
});

/* Approve/Reject */
function accionAprobarRechazar(eventId,nuevoStatus){
  const evts = obtenerEventos();
  const idx = evts.findIndex(x=>x.id===eventId);
  if(idx===-1) return alert('No encontrado');
  const ev = evts[idx];

  if(nuevoStatus==='Rechazada' && ev.deducted){
    const actuales = obtenerDiasPara(ev.employee);
    guardarDiasPara(ev.employee, actuales + ev.days);
    ev.deducted = false;
  }
  if(nuevoStatus==='Aprobada' && !ev.deducted && ev.type==='Vacaciones'){
    const actuales = obtenerDiasPara(ev.employee);
    const nuevos = Math.max(0, actuales - ev.days);
    guardarDiasPara(ev.employee, nuevos);
    ev.deducted = true;
  }
  ev.status = nuevoStatus;
  guardarEventos(evts);
  renderizarEventos();

  const asunto = `Tu solicitud (${ev.type}) ha sido ${ev.status.toLowerCase()}`;
  const params = { employee: ev.employee, type: ev.type, from_date: ev.fromDate, to_date: ev.toDate, comments: ev.comments || '', days_requested: ev.days, status: ev.status, subject: asunto, to_email: RRHH_EMAIL };

  emailjs.send(SERVICE_ID, TEMPLATE_ID, params)
    .then(()=>{
      if(ev.notifyEmail && ev.email){
        const paramsEmp = {...params, to_email: ev.email, subject: asunto + ' - Sala FORTUNY'};
        return emailjs.send(SERVICE_ID, TEMPLATE_ID, paramsEmp)
          .then(()=> alert(`Solicitud ${ev.status.toLowerCase()} y notificación enviada a ${ev.email}`))
          .catch(err=> { console.error('Error a empleado',err); alert(`Estado cambiado pero fallo notificación al empleado.`); });
      } else {
        alert(`Solicitud ${ev.status.toLowerCase()} y notificación enviada a RRHH.`);
      }
    })
    .catch(err=> { console.error('Error RRHH',err); alert(`Estado cambiado pero error notificando a RRHH.`); });
}

/* Admin modal & panel */
adminBtn.addEventListener('click', ()=> {
  adminModal.style.display='flex';
  adminPasswordInput.value=''; adminMsg.textContent='';
});
closeAdmin.addEventListener('click', ()=> adminModal.style.display='none');
closeAdminBtn.addEventListener('click', ()=> adminModal.style.display='none');
enterAdminBtn.addEventListener('click', ()=> {
  const val = adminPasswordInput.value.trim();
  if(val === ADMIN_PASSWORD){
    isAdmin = true;
    localStorage.setItem('og_admin_json','1');
    adminModal.style.display='none';
    alert('Modo ADMIN activado.');
    mostrarVistaAdmin();
    renderizarEventos();
  } else {
    adminMsg.textContent='Clave incorrecta';
  }
});
if(localStorage.getItem('og_admin_json')==='1'){
  isAdmin = true;
  mostrarVistaAdmin();
}

function mostrarVistaAdmin(){
  document.getElementById('contador').innerHTML = 'Modo administrador — <button id="salirAdmin" class="btn-mini">Salir</button>';
  document.getElementById('salirAdmin').addEventListener('click', ()=> {
    isAdmin = false; localStorage.removeItem('og_admin_json');
    location.reload();
  });
  renderEmployeesPanel();
}

verTodosBtn.addEventListener('click', ()=>{
  getAllEmployees().forEach(emp=>{
    const el = document.getElementById(`acc-${emp.replace(/\s/g,'_')}`);
    if(el){
      renderEmployeeRequests(emp,el);
      el.style.display = 'block';
    }
  });
});

reiniciarDiasBtn.addEventListener('click', ()=>{
  if(!confirm('Reiniciar todos los días a 30?')) return;
  getAllEmployees().forEach(emp => guardarDiasPara(emp, DIAS_VACACIONES_TOTALES));
  renderizarEventos();
  alert('Días reiniciados.');
});

exportXlsxBtn.addEventListener('click', ()=> {
  const evts = obtenerEventos();
  if(!evts.length) return alert('No hay datos.');
  const rows = evts.map(e=>({ Empleado:e.employee, Tipo:e.type, Desde:e.fromDate, Hasta:e.toDate, Dias:e.days, Estado:e.status, Email:e.email || '', Comentarios:e.comments || '', Creado:e.createdAt }));
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Solicitudes');
  XLSX.writeFile(wb, 'solicitudes_fortuny.xlsx');
});

exportJsonBtn.addEventListener('click', ()=> {
  const evts = obtenerEventos();
  const dias = {};
  getAllEmployees().forEach(emp => dias[emp] = obtenerDiasPara(emp));
  const payload = { events: evts, days: dias, exportedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'solicitudes_fortuny.json'; a.click();
  URL.revokeObjectURL(url);
});

/* Import JSON (user chooses file) */
importJsonInput.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = function(ev){
    try{
      const data = JSON.parse(ev.target.result);
      if(!data.events || typeof data.days !== 'object') return alert('JSON con formato inválido');
      guardarEventos(data.events);
      Object.keys(data.days).forEach(k => guardarDiasPara(k, data.days[k]));
      alert('Datos importados correctamente.');
      renderizarEventos();
    } catch(err){ console.error(err); alert('Error al leer JSON'); }
  };
  r.readAsText(f);
});

/* Listen data changed */
window.addEventListener('data:changed', ()=> renderizarEventos());

/* Utilities */
function getAllEmployees() { return Array.from(empleadoSelect.options).map(o=>o.value).filter(v=>v); }

/* Open edit from table */
function abrirModalEdicionFromTable(id){ abrirModalEdicion(id); }

/* Inicial load: try to load data/solicitudes.json into localStorage */
cargarJSONInicial().then(()=> { renderEmployeesPanel(); renderizarEventos(); });

/* render employees panel (definition reused) */
function renderEmployeesPanel(){
  const empleados = getAllEmployees();
  employeesList.innerHTML = '';
  empleados.forEach(emp=>{
    const dias = obtenerDiasPara(emp);
    const card = document.createElement('div');
    card.className = 'card-emp';
    card.innerHTML = `<div class="emp-head">
        <div>
          <div class="emp-name">${emp}</div>
          <div style="font-size:0.86rem;color:#7a6a5d">Vacaciones restantes</div>
        </div>
        <div style="text-align:right">
          <div class="emp-days">${dias}d</div>
          <div style="margin-top:8px"><button class="btn-mini" data-emp="${emp}">Ver solicitudes</button></div>
        </div>
      </div>
      <div class="accordion-content" id="acc-${emp.replace(/\s/g,'_')}"></div>`;
    employeesList.appendChild(card);
    const btn = card.querySelector('button[data-emp]');
    btn.addEventListener('click', ()=> toggleAccordion(emp));
  });
}

/* The rest of functions (toggleAccordion, renderEmployeeRequests, etc.) are already defined above and used */


      --muted:#d6b89a;
      --text:#362b24;
      --white:#ffffff;

      --vacaciones-dark:#a15a36;
      --libre-light:#f6dcc4;
      --asuntos-mid:#d7a67f;

      --status-approved:#7fb26f;
      --status-rejected:#c86b6b;
      --shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }
    header{
      background:#fffdf9;
      color:var(--text);
      padding:20px 12px;
      text-align:center;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
      border-bottom:1px solid #f0e7de;
    }
    header h1{ margin:0; font-size:1.3rem; letter-spacing:0.4px; font-weight:800;}
    .wrap{
      max-width:1200px;
      margin:22px auto;
      padding:0 16px 80px;
    }
    .top-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:18px;
    }
    #infoEmpleado{
      background:var(--panel);
      padding:10px 12px;
      border-radius:10px;
      box-shadow: var(--shadow);
      display:flex;
      gap:12px;
      align-items:center;
    }
    #infoEmpleado select{
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #e6d9c8;
      background: var(--white);
      color:var(--text);
      font-weight:600;
    }
    #contador{
      font-size:0.95rem;
      color:var(--accent-dark);
      font-weight:700;
      display:flex;
      align-items:center;
      gap:10px;
    }
    #adminBtn{
      background:transparent;
      border:1px dashed rgba(61,47,42,0.12);
      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
      color:var(--accent-dark);
      font-weight:600;
    }

    .layout {
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:18px;
      align-items:start;
    }

    /* left column admin panel */
    #adminCol {
      background:var(--panel);
      padding:12px;
      border-radius:12px;
      box-shadow: var(--shadow);
      max-height:calc(100vh - 140px);
      overflow:auto;
    }
    .admin-controls { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
    .card-emp {
      background:#fff;
      border-radius:10px;
      padding:10px;
      margin-bottom:10px;
      box-shadow:0 6px 14px rgba(0,0,0,0.04);
      border-left:6px solid #f0e7de;
    }
    .emp-head { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .emp-name { font-weight:800; color:var(--accent-dark); }
    .emp-days { font-weight:700; color:var(--accent-dark); }
    .btn-mini { padding:6px 8px; border-radius:8px; font-weight:700; cursor:pointer; border:none; background:var(--muted); color:var(--accent-dark); }
    .btn-mini.ghost { background:transparent; border:1px solid #efe1d3; }

    .accordion-content { margin-top:8px; display:none; background:#fffaf6; padding:8px; border-radius:8px; box-shadow:inset 0 2px 6px rgba(0,0,0,0.02); }
    table.admin-table { width:100%; border-collapse:collapse; margin-top:6px; font-size:0.92rem;}
    table.admin-table th, table.admin-table td { padding:6px 8px; text-align:left; border-bottom:1px solid #f0e7de; }
    .action-btn { padding:6px 8px; border-radius:6px; cursor:pointer; border:none; font-weight:700; }
    .action-approve { background:var(--status-approved); color:#fff; }
    .action-reject { background:var(--status-rejected); color:#fff; }
    .action-edit { background:#f0c4a6; color:var(--accent-dark); }
    .action-delete { background:#e3b4a0; color:var(--accent-dark); }

    /* calendar col */
    #calendarWrap { background:var(--panel); padding:12px; border-radius:12px; box-shadow:var(--shadow); }
    #calendar { border-radius:8px; }

    /* modal base reused from previous */
    .modal { display:none; position:fixed; z-index:80; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.35); justify-content:center; align-items:center;}
    .modal-content{ background:var(--white); width:92%; max-width:720px; border-radius:12px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,0.18); }
    .close{ float:right; font-size:20px; cursor:pointer; color:#9c7f67; }
    @media (max-width:1000px){
      .layout{ grid-template-columns: 1fr; }
      #adminCol{ max-height:none; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Sala - FORTUNY</h1>
  </header>

  <div class="wrap">
    <div class="top-row">
      <div id="infoEmpleado">
        <div style="margin-right:8px;font-size:0.95rem;color:var(--accent-dark);font-weight:700">Empleado:</div>
        <select id="empleadoSelect" aria-label="Selecciona empleado">
          <option value="">Selecciona tu nombre</option>
          <option>Justo Gomez</option>
          <option>Yustin Zambrano</option>
          <option>Julio Arias</option>
          <option>Francisco Soriano</option>
          <option>Valentin Naranjo</option>
          <option>Michelle Autelitano</option>
          <option>Santiago Germain</option>
          <option>Sanguita Karki</option>
          <option>Marianita Kurys</option>
          <option>Camila Calzadilla</option>
          <option>Gimena Vicente</option>
          <option>Radhika Barea</option>
          <option>Andrei Belei</option>
          <option>Marcos Fernandez</option>
          <option>Laura Delgado</option>
          <option>Enric Conill</option>
          <option>Gabriel Flores</option>
          <option>Alejandro Reñe</option>
          <option>Juliette Christiane</option>
          <option>Kiara Soledad</option>
          <option>Juana Ambrosoni</option>
          <option>Armin Rajabicheraghabadi</option>
          <option>Diego Lopez</option>
          <option>Julieta Salomone</option>
        </select>
      </div>

      <div style="display:flex;gap:12px;align-items:center">
        <div id="contador">Días disponibles: <span id="diasRestantes">30</span></div>
        <button id="adminBtn" title="Entrar como administrador">Entrar administrador</button>
      </div>
    </div>

    <div class="layout">
      <div id="adminCol">
        <div class="admin-controls">
          <button id="verTodosBtn" class="btn-mini">Ver todas</button>
          <button id="reiniciarDiasBtn" class="btn-mini">Reiniciar días</button>
          <button id="exportXlsxBtn" class="btn-mini">Exportar XLSX</button>
          <button id="exportJsonBtn" class="btn-mini">Guardar JSON</button>
          <label class="btn-mini ghost" style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">
            <input id="importJsonInput" type="file" accept=".json" style="display:none">
            Cargar JSON
          </label>
        </div>
        <div id="employeesList">
          <!-- cards via JS -->
        </div>
      </div>

      <div id="calendarWrap">
        <div id="calendar"></div>
      </div>
    </div>
  </div>

  <!-- modal (reused for create/edit) -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content" role="document">
      <span class="close" id="closeModal">&times;</span>
      <h2 id="modalTitle">Solicitud</h2>
      <form id="solicitudForm">
        <label>Tipo</label>
        <select id="tipo" required><option value="">Selecciona tipo</option><option>Vacaciones</option><option>Día libre</option><option>Asuntos propios</option></select>

        <div style="display:flex;gap:8px;margin-top:8px">
          <div style="flex:1">
            <label>Desde</label>
            <input id="desde" type="datetime-local" required>
          </div>
          <div style="flex:1">
            <label>Hasta</label>
            <input id="hasta" type="datetime-local" required>
          </div>
        </div>

        <div style="margin-top:8px">
          <label style="display:flex;gap:8px;align-items:center">
            <input id="notifyCheckbox" type="checkbox"> Deseo recibir notificación
          </label>
          <div id="emailWrap" style="display:none;margin-top:8px">
            <label>Email (opcional)</label>
            <input id="email" type="email" placeholder="tu@ejemplo.com">
          </div>
        </div>

        <label style="margin-top:8px">Comentarios</label>
        <textarea id="comentarios" placeholder="Motivo (opcional)"></textarea>

        <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
          <button id="submitBtn" class="btn" type="submit">Enviar</button>
          <button id="saveChangesBtn" class="btn" type="button" style="display:none">Guardar</button>
          <button id="deleteBtn" class="btn secondary" type="button" style="display:none">Eliminar</button>
          <button id="cancelBtn" class="btn secondary" type="button">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Admin password modal -->
  <div id="adminModal" class="modal" aria-hidden="true">
    <div class="modal-content" style="max-width:420px">
      <span class="close" id="closeAdmin">&times;</span>
      <h2>Acceso administrador</h2>
      <p class="small-muted">Introduce la clave para ver todas las solicitudes.</p>
      <input id="adminPassword" type="password" placeholder="Clave administradora">
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="enterAdmin" class="btn">Entrar</button>
        <button id="closeAdminBtn" class="btn secondary">Cerrar</button>
      </div>
      <div id="adminMsg" style="margin-top:10px;color:#8a3d3d;font-weight:700;"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="./script.js"></script>
</body>
</html>
